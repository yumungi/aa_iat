<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Alopecia IAT</title>

  <!-- jsPsych CSS (browser-ready bundle) -->
  <link
    href="https://cdn.jsdelivr.net/npm/jspsych@7.3.0/dist/css/jspsych.css"
    rel="stylesheet"
    type="text/css"
  />
</head>
<body></body>

<!-- jsPsych core (browser bundle exposes window.jsPsych) -->
<script src="https://cdn.jsdelivr.net/npm/jspsych@7.3.0/dist/index.browser.min.js"></script>
<!-- Built-in plugins (browser bundles) -->
<script src="https://cdn.jsdelivr.net/npm/jspsych@7.3.0/dist/plugins/jspsych-html-button-response.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspsych@7.3.0/dist/plugins/jspsych-html-keyboard-response.js"></script>
<!-- Hammer.js for swipe detection -->
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>

<script>
/* ====  MAIN IAT CODE  ==== */
(async function () {
  /* 0.  Initialise jsPsych and timeline  */
  const jsPsych = initJsPsych();
  const timeline = [];

  /* 1.  Google Sheet endpoint  */
  const WEB_APP_URL =
    "https://script.google.com/macros/s/AKfycbw1KZCy_46ZFKajTjZdYH4hRr3Gz0moetyIeYpCBQRe8s15UMrwt3znAsmhzomfN8D7/exec";

  /* 2.  Stimuli  */
  const alopeciaImages = Array.from({ length: 5 }, (_, i) => `alopecia-${i + 1}.jpg`);
  const hairImages     = Array.from({ length: 5 }, (_, i) => `hair-${i + 1}.jpg`);
  const goodWords = [
    "Friend","Together","Trusted","Familiar","Safe","Accepted","Family","Included"
  ];
  const badWords  = [
    "Stranger","Isolated","Weird","Rejected","Different","Excluded","Awkward","Them"
  ];

  const imgTrials  = (arr, side) => arr.map(fn => ({
    stimulus: `<img src="${fn}" style="max-width:80vw;max-height:60vh;">`,
    correct: side
  }));
  const wordTrials = (arr, side) => arr.map(w => ({
    stimulus: `<p style="font-size:2em;">${w}</p>`,
    correct: side
  }));
  const repeat = (arr, n) => Array(n).fill(arr).flat();

  /* 3.  Build trial sets for each block  */
  const block1 = jsPsych.randomization.shuffle(
    repeat(imgTrials(alopeciaImages,'left').concat(imgTrials(hairImages,'right')),2)
  );
  const block2 = jsPsych.randomization.shuffle(
    wordTrials(goodWords,'left').concat(wordTrials(badWords,'right'))
  );
  const block3 = jsPsych.randomization.shuffle(
    imgTrials(alopeciaImages,'left')
      .concat(imgTrials(hairImages,'right'))
      .concat(wordTrials(goodWords,'left'))
      .concat(wordTrials(badWords,'right'))
  );
  const block4 = jsPsych.randomization.shuffle(repeat(block3,2));
  const block5 = jsPsych.randomization.shuffle(
    repeat(imgTrials(hairImages,'left').concat(imgTrials(alopeciaImages,'right')),2)
  );
  const block6 = jsPsych.randomization.shuffle(
    imgTrials(hairImages,'left')
      .concat(imgTrials(alopeciaImages,'right'))
      .concat(wordTrials(goodWords,'left'))
      .concat(wordTrials(badWords,'right'))
  );
  const block7 = jsPsych.randomization.shuffle(repeat(block6,2));

  /* 4.  Consent  */
  timeline.push({
    type: 'html-button-response',
    stimulus: `
      <h2>Welcome</h2>
      <p>This test measures unconscious bias toward people with alopecia areata.</p>
      <p>You will <strong>swipe left/right</strong> to categorise items.</p>
      <p>Click “I consent” to begin.</p>
    `,
    choices: ['I do not consent', 'I consent'],
    on_finish: d => {
      if (d.response === 0) jsPsych.endExperiment('You chose not to participate.');
    }
  });

  /* 5.  Participant ID  */
  const participantID = jsPsych.randomization.randomID(8);
  timeline.push({
    type: 'html-button-response',
    stimulus: `<p>Your participant ID:</p><h3>${participantID}</h3>`,
    choices: ['Start']
  });

  /* 6.  Helper to add each IAT block  */
  function addBlock(num, label, trialsArr) {
    /* instructions */
    timeline.push({
      type: 'html-button-response',
      stimulus: `<h3>Block ${num}</h3>
        <p><strong>Left:</strong> ${label.left}<br><strong>Right:</strong> ${label.right}</p>`,
      choices: ['Begin']
    });

    /* trials */
    timeline.push({
      timeline: [
        {
          type: 'html-keyboard-response',
          stimulus: jsPsych.timelineVariable('stimulus'),
          choices: "NO_KEYS",
          trial_duration: 10000,
          data: {
            participantID,
            block: num,
            correct_response: jsPsych.timelineVariable('correct')
          },
          on_start: t => {
            t.startTime = Date.now();
            if (!window.hammer) window.hammer = new Hammer(document.body);
            t.swipeFunc = e => {
              const rt   = Date.now() - t.startTime;
              const resp = e.type === 'swipeleft' ? 'left' : 'right';
              const ok   = resp === t.data.correct_response;
              window.hammer.off('swipeleft swiperight', t.swipeFunc);
              jsPsych.finishTrial({ response: resp, rt, correct: ok });
            };
            window.hammer.on('swipeleft swiperight', t.swipeFunc);
          }
        },
        {
          timeline: [{
            type: 'html-keyboard-response',
            stimulus: '<div style="font-size:4em;color:red;">X</div>',
            choices: [],
            trial_duration: 500
          }],
          conditional_function: () => !jsPsych.data.get().last(1).values()[0].correct
        }
      ],
      timeline_variables: trialsArr,
      randomize_order: true
    });

    /* push results to Sheet */
    timeline.push({
      type: 'call-function',
      func: () => {
        fetch(WEB_APP_URL, {
          method: 'POST',
          body: JSON.stringify(jsPsych.data.get().filter({block: num}).values())
        });
      }
    });
  }

  /* 7.  Assemble all seven IAT blocks  */
  addBlock(1,{left:'Alopecia',right:'No Alopecia'},block1);
  addBlock(2,{left:'Good',right:'Bad'},block2);
  addBlock(3,{left:'Alopecia + Good',right:'No Alopecia + Bad'},block3);
  addBlock(4,{left:'Alopecia + Good',right:'No Alopecia + Bad'},block4);
  addBlock(5,{left:'No Alopecia',right:'Alopecia'},block5);
  addBlock(6,{left:'Good + No Alopecia',right:'Bad + Alopecia'},block6);
  addBlock(7,{left:'Good + No Alopecia',right:'Bad + Alopecia'},block7);

  /* 8.  Debrief  */
  timeline.push({
    type: 'html-button-response',
    stimulus: () => {
      const all = jsPsych.data.get().filter(t => t.correct !== undefined).values();
      const acc = all.filter(t => t.correct).length / all.length;

      const clean = arr => arr.filter(rt => rt >= 300 && rt <= 10000);
      const mean  = arr => arr.reduce((a,b)=>a+b,0) / arr.length;

      const r4 = clean(jsPsych.data.get().filter({block:4,correct:true}).select('rt').values);
      const r7 = clean(jsPsych.data.get().filter({block:7,correct:true}).select('rt').values);
      const m4 = mean(r4), m7 = mean(r7);
      const pool = r4.concat(r7);
      const sd = Math.sqrt(pool.map(x => Math.pow(x - (m4 + m7) / 2, 2)).reduce((a,b)=>a+b,0) / pool.length);
      const dScore = (m7 - m4) / sd;

      return `
        <h2>Finished!</h2>
        <p>Accuracy: ${(acc * 100).toFixed(1)}%</p>
        <p>IAT D-score: ${dScore.toFixed(2)}</p>
      `;
    },
    choices: ['Close']
  });

  /* 9.  Run the experiment  */
  jsPsych.run(timeline);
})();
</script>
